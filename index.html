<!DOCTYPE html>
<html lang="en">
<head>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1335151788577064"
     crossorigin="anonymous"></script>  
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mix Music Cloud</title>
<style>
  :root {
    --bg:#0b0f1a; --bg2:#0e1424; --panel:#121a2b; --text:#e6eef7; --muted:#9fb3c8;
    --accent:#6ee7ff; --accent2:#a78bfa; --radius:12px; --shadow:0 10px 30px rgba(0,0,0,.35);
  }
  * { box-sizing:border-box }
  body { margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:#0b0f1a; color:var(--text); }
  .app {
    display:grid; grid-template-columns:220px 1fr; grid-template-rows:auto 1fr 90px;
    grid-template-areas:"sidebar header" "sidebar main" "player player"; height:100vh;
  }
  @media (max-width: 900px) {
    .app { grid-template-columns:1fr; grid-template-areas:"header" "main" "player"; }
    aside { display:none; }
  }
  header { grid-area:header; display:flex; align-items:center; gap:12px; padding:12px; background:rgba(255,255,255,.04); }
  .brand { display:flex; align-items:center; gap:10px; font-weight:700; }
  .logo { width:32px; height:32px; border-radius:50%; background:conic-gradient(from 210deg, var(--accent), var(--accent2)); }
  .searchbar { margin-left:auto; display:flex; gap:8px; }
  .searchbar input { width:220px; padding:8px; border-radius:8px; border:1px solid #24304f; background:#0f1628; color:var(--text); }
  .searchbar button { padding:8px 12px; border:none; border-radius:8px; background:#1f2b52; color:var(--accent); font-weight:600; cursor:pointer; }
  .userbox { margin-left:8px; display:flex; align-items:center; gap:8px; }
  .userbox .nick { font-weight:700; }
  aside { grid-area:sidebar; background:var(--bg2); padding:12px; overflow:auto; }
  .nav-btn { display:block; width:100%; margin:6px 0; padding:10px; background:#0f1628; color:var(--text); border:none; border-radius:10px; cursor:pointer; text-align:left; }
  .nav-btn.active { outline:2px solid var(--accent); }
  main { grid-area:main; padding:12px; overflow:auto; }
  .grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fit, minmax(160px, 1fr)); }
  .card { background:#0f1628; border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }
  .card-body { padding:10px; }
  .title { font-weight:700; }
  .meta { color:var(--muted); font-size:.9rem; }
  .btn { padding:6px 10px; border-radius:8px; border:none; background:#1a2440; color:var(--text); cursor:pointer; }
  .btn.primary { background:#1f2b52; color:var(--accent); font-weight:600; }
  .player {
    grid-area:player; display:grid; grid-template-columns:1fr auto auto; align-items:center; gap:12px;
    padding:12px; background:var(--panel);
  }
  .mini { display:flex; align-items:center; gap:10px; }
  .mini img { width:56px; height:56px; border-radius:10px; object-fit:cover; }
  .controls { display:flex; gap:8px; }
  .seek { display:flex; align-items:center; gap:8px; }
  input[type="range"] { accent-color: var(--accent); }
  .form-grid { display:grid; gap:8px; grid-template-columns:1fr; margin-top:8px; }
  input[type="text"], input[type="email"], input[type="password"], input[type="url"], input[type="file"] {
    padding:8px; border-radius:8px; border:1px solid #24304f; background:#0f1628; color:var(--text);
  }
  .folder-card { cursor:pointer; }
  .folder-card img { width:100%; height:100px; object-fit:cover; }
  .badge { position:absolute; bottom:6px; right:6px; font-size:1.2rem; }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .link { color:var(--accent); text-decoration:none; }
  .auth { display:flex; gap:8px; }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand"><div class="logo" aria-hidden="true"></div><div>Mix Music Cloud</div></div>
    <div class="searchbar">
      <label for="searchInput" class="sr-only" style="position:absolute;left:-9999px;">Search</label>
      <input id="searchInput" type="text" placeholder="Search title, artist, genre‚Ä¶" />
      <button id="searchBtn" aria-label="Search">Search</button>
    </div>
    <div class="userbox" id="userBox">
      <button class="btn" id="loginBtn">Log in</button>
      <button class="btn" id="signupBtn">Sign up</button>
    </div>
  </header>

  <aside>
    <button class="nav-btn" data-view="home">Home</button>
    <button class="nav-btn" data-view="catalog">Catalog</button>
    <button class="nav-btn" data-view="uploads">Uploads</button>
    <button class="nav-btn" data-view="playlists">Playlists</button>
    <button class="nav-btn" data-view="trending">Trending</button>
    <button class="nav-btn" data-view="featured">Featured Music</button>
    <button class="nav-btn" data-view="updates">Manage Updates</button>
    <button class="nav-btn" data-view="featuredAnnouncements">Featured Announcements</button>
    <button class="nav-btn" data-view="gamesLinks">Games</button>
    <div style="margin-top:12px;">
      <div class="title">Support us</div>
      <button id="donatePayPal" class="btn primary">Donate via PayPal</button>
    </div>
  </aside>

  <main id="viewContainer"></main>

  <div class="player">
    <div class="mini">
      <img id="miniCover" alt="Current track cover" />
      <div>
        <div id="nowTitle" class="title">Idle ‚Äî select a track</div>
        <div id="nowMeta" class="meta">‚Äî</div>
      </div>
    </div>
    <div class="controls">
      <button class="btn" id="prevBtn" aria-label="Previous">‚èÆ</button>
      <button class="btn" id="playPauseBtn" aria-label="Play or pause">‚ñ∂</button>
      <button class="btn" id="nextBtn" aria-label="Next">‚è≠</button>
    </div>
    <div class="seek">
      <span id="curTime">0:00</span>
      <input id="seekRange" type="range" min="0" max="100" value="0" />
      <span id="durTime">0:00</span>
      üîä <input id="volRange" type="range" min="0" max="1" step="0.01" value="0.8" aria-label="Volume" />
    </div>
    <audio id="audio"></audio>
  </div>
</div>

<script>
/* --- Persistence --- */
const store = {
  get: (k, f) => { try { return JSON.parse(localStorage.getItem(k)) ?? f; } catch { return f; } },
  set: (k, v) => localStorage.setItem(k, JSON.stringify(v))
};

/* --- State --- */
const state = {
  tracks: store.get("mc_tracks", []),
  playlists: store.get("mc_playlists", []),
  updates: store.get("mc_updates", []),
  users: store.get("mc_users", []),       // [{email, nick, passHash}]
  session: store.get("mc_session", null), // {email, nick}
  currentIndex: -1,
  isPlaying: false,
  view: "home",
  search: ""
};
/* Persist but do not store transient blob: object URLs. For persistent storage you should use IndexedDB or a backend. */
function persist() {
  // create a safe copy of tracks for storage (strip blob: object URLs)
  const tracksToStore = state.tracks.map(t => {
    const copy = Object.assign({}, t);
    if (copy.src && copy.src.startsWith && copy.src.startsWith('blob:')) delete copy.src;
    return copy;
  });
  store.set("mc_tracks", tracksToStore);
  store.set("mc_playlists", state.playlists);
  store.set("mc_updates", state.updates);
  store.set("mc_users", state.users);
  store.set("mc_session", state.session);
}

/* --- Genre helpers --- */
const genreImages = {
  rock: "https://picsum.photos/seed/rockFolder/200/200",
  jazz: "https://picsum.photos/seed/jazzFolder/200/200",
  electronic: "https://picsum.photos/seed/electronicFolder/200/200",
  pop: "https://picsum.photos/seed/popFolder/200/200",
  classical: "https://picsum.photos/seed/classicalFolder/200/200",
  hiphop: "https://picsum.photos/seed/hiphopFolder/200/200",
  metal: "https://picsum.photos/seed/metalFolder/200/200",
  unsorted: "https://picsum.photos/seed/unsortedFolder/200/200"
};
function defaultCoverForGenre(genre, id) {
  const g = (genre || "unsorted").toLowerCase();
  return genreImages[g] || genreImages.unsorted;
}
function genreBadge(genre) {
  const g = (genre || "").toLowerCase();
  if (g.includes("rock")) return "üé∏";
  if (g.includes("jazz")) return "üé∑";
  if (g.includes("electronic")) return "üéõÔ∏è";
  if (g.includes("pop")) return "üé§";
  if (g.includes("classical")) return "üéπ";
  if (g.includes("hip")) return "üéß";
  if (g.includes("metal")) return "ü§ò";
  return "üéµ";
}
function groupTracksByGenre() {
  const folders = {};
  state.tracks.forEach(t => {
    const g = ((t.genre || "unsorted").toLowerCase());
    if (!folders[g]) folders[g] = [];
    folders[g].push(t);
  });
  return folders;
}

/* --- Auth (local-only) --- */
/* NOTE: Client-side auth is for demo only. Do not use for production.
   Prefer a backend with secure password hashing (bcrypt/argon2) and proper session handling. */

/* Better demo hash using Web Crypto (SHA-256). Still not a replacement for server-side password hashing. */
async function hash(s) {
  try {
    const enc = new TextEncoder();
    const data = enc.encode(s);
    const digest = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(digest)).map(b => b.toString(16).padStart(2, '0')).join('');
  } catch (e) {
    // fallback to simple non-crypto hash if Web Crypto unavailable
    let h = 0; for (let i=0;i<s.length;i++) h = (h<<5)-h + s.charCodeAt(i); return String(h);
  }
}
async function signup(email, pass, nick) {
  email = email.trim().toLowerCase();
  if (!email || !pass || !nick) return { ok:false, msg:"All fields required." };
  if (state.users.find(u => u.email === email)) return { ok:false, msg:"Email already registered." };
  const passHash = await hash(pass);
  state.users.push({ email, passHash, nick });
  state.session = { email, nick };
  persist();
  return { ok:true };
}
async function login(email, pass) {
  email = email.trim().toLowerCase();
  const u = state.users.find(u => u.email === email);
  const ph = await hash(pass);
  if (!u || u.passHash !== ph) return { ok:false, msg:"Invalid credentials." };
  state.session = { email, nick: u.nick };
  persist();
  return { ok:true };
}
function logout() { state.session = null; persist(); renderUserBox(); }

/* --- UI: user box --- */
function renderUserBox() {
  const box = document.getElementById("userBox");
  box.innerHTML = "";
  if (state.session) {
    const nick = document.createElement("span");
    nick.className = "nick";
    nick.textContent = state.session.nick;
    const out = document.createElement("button");
    out.className = "btn";
    out.textContent = "Log out";
    out.onclick = () => { logout(); };
    box.append(nick, out);
  } else {
    const loginBtn = document.createElement("button");
    loginBtn.className = "btn"; loginBtn.textContent = "Log in";
    loginBtn.onclick = () => showAuth("login");
    const signupBtn = document.createElement("button");
    signupBtn.className = "btn"; signupBtn.textContent = "Sign up";
    signupBtn.onclick = () => showAuth("signup");
    box.append(loginBtn, signupBtn);
  }
}
function showAuth(mode) {
  const vc = document.getElementById("viewContainer");
  vc.innerHTML = "";
  const card = document.createElement("div"); card.className = "card";
  const body = document.createElement("div"); body.className = "card-body";
  const title = document.createElement("div"); title.className = "title";
  title.textContent = mode === "login" ? "Log in" : "Sign up";
  const form = document.createElement("div"); form.className = "form-grid";
  const email = document.createElement("input"); email.type="email"; email.placeholder="Email";
  const pass = document.createElement("input"); pass.type="password"; pass.placeholder="Password";
  form.append(email, pass);
  let nick;
  if (mode === "signup") { nick = document.createElement("input"); nick.type="text"; nick.placeholder="Nickname"; form.append(nick); }
  const row = document.createElement("div"); row.className="row";
  const submit = document.createElement("button"); submit.className="btn primary"; submit.textContent = mode === "login" ? "Log in" : "Create account";
  const cancel = document.createElement("button"); cancel.className="btn"; cancel.textContent="Cancel";
  cancel.onclick = () => render();
  submit.onclick = async () => {
    // login/signup are async now
    const res = mode === "login" ? await login(email.value, pass.value) : await signup(email.value, pass.value, nick ? nick.value : "");
    if (!res.ok) { alert(res.msg); return; }
    renderUserBox(); render();
  };
  row.append(submit, cancel);
  body.append(title, form, row);
  card.append(body); vc.append(card);
}

/* --- Navigation --- */
function setActiveNav(view) {
  document.querySelectorAll(".nav-btn").forEach(b => b.classList.toggle("active", b.dataset.view === view));
}
document.querySelectorAll(".nav-btn").forEach(btn => {
  btn.onclick = () => { state.view = btn.dataset.view; setActiveNav(state.view); render(); };
});
document.getElementById("donatePayPal").onclick = () => {
  const w = window.open("https://freedomigame.kesug.com/?i=1", "_blank");
  if (w) try { w.opener = null; } catch(e){ /* ignore */ }
};

/* --- Search --- */
document.getElementById("searchBtn").onclick = () => { state.search = (document.getElementById("searchInput").value || "").trim().toLowerCase(); render(); };
document.getElementById("searchInput").addEventListener("keydown", e => { if (e.key === "Enter") { state.search = (e.target.value || "").trim().toLowerCase(); render(); } });

/* --- Cards --- */
function trackCard(t) {
  const card = document.createElement("div"); card.className = "card";
  const coverWrap = document.createElement("div"); coverWrap.style.position="relative";
  const cover = document.createElement("img");
  cover.src = t.cover && t.cover.trim() ? t.cover : defaultCoverForGenre(t.genre, t.id);
  cover.alt = t.title || "Track cover";
  cover.style.width="100%"; cover.style.height="140px"; cover.style.objectFit="cover";
  const badge = document.createElement("div"); badge.className="badge"; badge.textContent = genreBadge(t.genre);
  coverWrap.append(cover, badge);
  const body = document.createElement("div"); body.className="card-body";
  const title = document.createElement("div"); title.className="title"; title.textContent = t.title || "Untitled";
  const meta = document.createElement("div"); meta.className="meta"; meta.textContent = `${t.artist || "Unknown"} ‚Ä¢ ${t.genre || "Unsorted"} ‚Ä¢ ${t.plays || 0} plays`;
  const row = document.createElement("div"); row.className="row";
  const play = document.createElement("button"); play.className="btn primary"; play.textContent="Play"; play.onclick = () => playTrackById(t.id);
  const like = document.createElement("button"); like.className="btn"; like.textContent = `‚ù§ ${t.likes || 0}`; like.onclick = () => { t.likes = (t.likes||0)+1; persist(); render(); };
  row.append(play, like);
  body.append(title, meta, row);
  card.append(coverWrap, body);
  return card;
}

/* --- Views --- */
function renderHome() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Genre folders";
  const grid = document.createElement("div"); grid.className="grid";
  const folders = groupTracksByGenre();
  Object.keys(genreImages).forEach(g => {
    const card = document.createElement("div"); card.className="card folder-card";
    const img = document.createElement("img"); img.src = genreImages[g];
    const body = document.createElement("div"); body.className="card-body";
    const t = document.createElement("div"); t.className="title"; t.textContent = g.toUpperCase();
    const m = document.createElement("div"); m.className="meta"; m.textContent = `${(folders[g]||[]).length} tracks`;
    body.append(t, m); card.append(img, body);
    card.onclick = () => renderFolderTracks(g, folders[g]||[]);
    grid.append(card);
  });
  wrap.append(title, grid);
  return wrap;
}
function renderFolderTracks(genre, tracks) {
  const wrap = document.createElement("div");
  const row = document.createElement("div"); row.className="row";
  const back = document.createElement("button"); back.className="btn"; back.textContent="‚Üê Back to folders"; back.onclick = () => { state.view="home"; setActiveNav(state.view); render(); };
  const title = document.createElement("div"); title.className="title"; title.textContent = `${genre.toUpperCase()} ‚Äî ${tracks.length} tracks`;
  row.append(back, title); wrap.append(row);
  const grid = document.createElement("div"); grid.className="grid";
  const q = state.search;
  tracks.filter(t => {
    const hay = ((t.title||"") + (t.artist||"") + (t.genre||"")).toLowerCase();
    return !q || hay.includes(q);
  }).forEach(t => grid.append(trackCard(t)));
  wrap.append(grid);
  const vc = document.getElementById("viewContainer"); vc.innerHTML=""; vc.append(wrap);
}
function renderCatalog() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Catalog";
  const grid = document.createElement("div"); grid.className="grid";
  const q = state.search;
  state.tracks.filter(t => {
    const hay = ((t.title||"") + (t.artist||"") + (t.genre||"")).toLowerCase();
    return !q || hay.includes(q);
  }).forEach(t => grid.append(trackCard(t)));
  wrap.append(title, grid); return wrap;
}
function renderUploads() {
  const wrap = document.createElement("div");
  const card = document.createElement("div"); card.className="card";
  const body = document.createElement("div"); body.className="card-body";
  const title = document.createElement("div"); title.className="title"; title.textContent="Upload a track";
  const form = document.createElement("div"); form.className="form-grid";
  const fileInput = document.createElement("input"); fileInput.type="file"; fileInput.accept="audio/mp3,audio/mpeg";
  const titleInput = document.createElement("input"); titleInput.type="text"; titleInput.placeholder="Title";
  const artistInput = document.createElement("input"); artistInput.type="text"; artistInput.placeholder="Artist";
  const genreInput = document.createElement("input"); genreInput.type="text"; genreInput.placeholder="Genre (e.g., Rock, Jazz)";
  const coverInput = document.createElement("input"); coverInput.type="url"; coverInput.placeholder="Cover URL (optional)";
  const submit = document.createElement("button"); submit.className="btn primary"; submit.textContent="Upload";
  submit.onclick = () => {
    if (!fileInput.files.length) { alert("Please select an MP3 file."); return; }
    const file = fileInput.files[0];
    // optional: validate MIME and size
    if (!/audio/.test(file.type)) { if (!confirm("Selected file does not look like audio. Continue?")) return; }
    if (file.size > 50 * 1024 * 1024) { if (!confirm("File is larger than 50MB. Continue?")) return; }
    const src = URL.createObjectURL(file);
    const id = "t" + Math.random().toString(36).slice(2,8);
    const track = {
      id,
      title: titleInput.value.trim() || file.name,
      artist: artistInput.value.trim() || "Unknown Artist",
      genre: genreInput.value.trim() || "unsorted",
      cover: coverInput.value.trim(),
      src,               // transient blob URL, not persisted to localStorage
      likes: 0,
      plays: 0,
      created: Date.now()
    };
    state.tracks.push(track); persist();
    alert("Track uploaded successfully!");
    state.view = "home"; setActiveNav(state.view); render();
  };
  form.append(fileInput, titleInput, artistInput, genreInput, coverInput, submit);
  body.append(title, form); card.append(body); wrap.append(card); return wrap;
}
function renderPlaylists() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Playlists";
  const meta = document.createElement("div"); meta.className="meta"; meta.textContent="(Placeholder) Create playlists in a future step.";
  wrap.append(title, meta); return wrap;
}
function renderTrending() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Trending";
  const grid = document.createElement("div"); grid.className="grid";
  [...state.tracks].sort((a,b)=>(b.plays||0)-(a.plays||0)).slice(0,20).forEach(t=>grid.append(trackCard(t)));
  wrap.append(title, grid); return wrap;
}
function renderFeaturedMusic() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Featured Music";
  const grid = document.createElement("div"); grid.className="grid";
  [...state.tracks].sort((a,b)=>(b.likes||0)-(a.likes||0)).slice(0,20).forEach(t=>grid.append(trackCard(t)));
  wrap.append(title, grid); return wrap;
}
function renderUpdatesPanel() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Manage Updates";
  wrap.append(title);
  state.updates.forEach((u, idx) => {
    const card = document.createElement("div"); card.className="card";
    const body = document.createElement("div"); body.className="card-body";
    const meta = document.createElement("div"); meta.className="meta"; meta.textContent = new Date(u.ts).toLocaleString();
    const text = document.createElement("div"); text.textContent = u.text;
    const del = document.createElement("button"); del.className="btn"; del.textContent="Delete";
    del.onclick = () => { state.updates.splice(idx,1); persist(); render(); };
    body.append(meta, text, del); card.append(body); wrap.append(card);
  });
  const input = document.createElement("input"); input.type="text"; input.placeholder="Write a new update‚Ä¶";
  const add = document.createElement("button"); add.className="btn primary"; add.textContent="Add Update";
  add.onclick = () => { if (!input.value.trim()) return; state.updates.push({ text: input.value.trim(), ts: Date.now() }); persist(); render(); };
  wrap.append(input, add); return wrap;
}
function renderFeaturedAnnouncements() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Featured Announcements";
  const grid = document.createElement("div"); grid.className="grid";
  const featured = (state.updates||[]).slice(-3);
  if (!featured.length) { const msg = document.createElement("div"); msg.className="meta"; msg.textContent="No featured announcements yet."; wrap.append(title, msg); return wrap; }
  featured.forEach(u => {
    const card = document.createElement("div"); card.className="card";
    const body = document.createElement("div"); body.className="card-body";
    const meta = document.createElement("div"); meta.className="meta"; meta.textContent = new Date(u.ts).toLocaleString();
    const text = document.createElement("div"); text.className="title"; text.textContent = u.text;
    body.append(meta, text); card.append(body); grid.append(card);
  });
  wrap.append(title, grid); return wrap;
}
function renderGamesLinks() {
  const wrap = document.createElement("div");
  const title = document.createElement("div"); title.className="title"; title.textContent="Games (external links)";
  const list = document.createElement("div"); list.className="row";
  const games = [
    { name:"2048 Puzzle", url:"https://play2048.co/" },
    { name:"Pac-Man", url:"https://pacman.live/" },
    { name:"Tetris", url:"https://tetris.com/play-tetris" },
    { name:"Snake Game", url:"https://playsnake.org/" }
  ];
  games.forEach(g => { const a = document.createElement("a"); a.href=g.url; a.target="_blank"; a.rel="noopener noreferrer"; a.className="link"; a.textContent=g.name; list.append(a); });
  wrap.append(title, list); return wrap;
}

/* --- Player --- */
const audio = document.getElementById("audio");
const playPauseBtn = document.getElementById("playPauseBtn");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const seekRange = document.getElementById("seekRange");
const volRange = document.getElementById("volRange");
const curTime = document.getElementById("curTime");
const durTime = document.getElementById("durTime");
const miniCover = document.getElementById("miniCover");
const nowTitle = document.getElementById("nowTitle");
const nowMeta = document.getElementById("nowMeta");

audio.volume = parseFloat(volRange.value || "0.8");
const fmtTime = s => { if (!isFinite(s)) return "0:00"; const m = Math.floor(s/60); const r = Math.floor(s%60); return `${m}:${String(r).padStart(2,"0")}`; };

function playTrackById(id) {
  const idx = state.tracks.findIndex(t => t.id === id);
  if (idx < 0) return;
  state.currentIndex = idx;
  const t = state.tracks[idx];
  const cover = (t.cover && t.cover.trim()) ? t.cover : defaultCoverForGenre(t.genre, t.id);
  if (!t.src) {
    // no persisted or transient source ‚Äî can't play. Notify user.
    alert("This track has no playable source in this session. Re-upload or use a hosted URL.");
    return;
  }
  audio.src = t.src;
  audio.play().then(() => {
    state.isPlaying = true; playPauseBtn.textContent = "‚è∏";
    miniCover.src = cover;
    nowTitle.textContent = `${t.title || "Untitled"} ${genreBadge(t.genre)}`;
    nowMeta.textContent = `${t.artist || "Unknown"} ‚Ä¢ ${t.genre || "Unsorted"}`;
    t.plays = (t.plays || 0) + 1; persist();
  }).catch(() => alert("Unable to play audio source."));
}
function playPause() {
  if (state.currentIndex < 0) { const first = state.tracks[0]; if (first) playTrackById(first.id); return; }
  if (state.isPlaying) { audio.pause(); state.isPlaying=false; playPauseBtn.textContent="‚ñ∂"; }
  else { audio.play(); state.isPlaying=true; playPauseBtn.textContent="‚è∏"; }
}
function next() { if (!state.tracks.length) return; state.currentIndex = (state.currentIndex + 1) % state.tracks.length; playTrackById(state.tracks[state.currentIndex].id); }
function prev() { if (!state.tracks.length) return; state.currentIndex = (state.currentIndex - 1 + state.tracks.length) % state.tracks.length; playTrackById(state.tracks[state.currentIndex].id); }

playPauseBtn.onclick = playPause; nextBtn.onclick = next; prevBtn.onclick = prev;
volRange.oninput = () => audio.volume = parseFloat(volRange.value);
audio.addEventListener("timeupdate", () => {
  const cur = audio.currentTime || 0; const dur = audio.duration || 0;
  curTime.textContent = fmtTime(cur); durTime.textContent = fmtTime(dur);
  seekRange.value = dur > 0 ? Math.floor((cur / dur) * 100) : 0;
});
seekRange.oninput = () => { const dur = audio.duration || 0; if (dur > 0) { const pct = parseInt(seekRange.value,10)/100; audio.currentTime = dur * Math.min(Math.max(pct,0),1); } };
audio.addEventListener("ended", () => next());
document.addEventListener("keydown", e => {
  // ignore typing and contenteditable
  if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.isContentEditable)) return;
  if (e.code === "Space") { e.preventDefault(); playPause(); }
  if (e.code === "ArrowRight") audio.currentTime += 5;
  if (e.code === "ArrowLeft") audio.currentTime -= 5;
  if (e.code === "ArrowUp") audio.volume = Math.min(1, audio.volume + 0.05);
  if (e.code === "ArrowDown") audio.volume = Math.max(0, audio.volume - 0.05);
});

/* --- Revoke blob object URLs on unload to avoid leaks --- */
window.addEventListener('beforeunload', () => {
  state.tracks.forEach(t => {
    try { if (t.src && t.src.startsWith && t.src.startsWith('blob:')) URL.revokeObjectURL(t.src); } catch(e){}
  });
});

/* --- Root render --- */
function render() {
  const vc = document.getElementById("viewContainer"); vc.innerHTML = "";
  let node;
  switch (state.view) {
    case "home": node = renderHome(); break;
    case "catalog": node = renderCatalog(); break;
    case "uploads": node = renderUploads(); break;
    case "playlists": node = renderPlaylists(); break;
    case "trending": node = renderTrending(); break;
    case "featured": node = renderFeaturedMusic(); break;
    case "updates": node = renderUpdatesPanel(); break;
    case "featuredAnnouncements": node = renderFeaturedAnnouncements(); break;
    case "gamesLinks": node = renderGamesLinks(); break;
    default: node = renderHome();
  }
  vc.appendChild(node);
}

/* --- Init --- */
state.view = "home"; setActiveNav(state.view); renderUserBox(); render();
</script>
</body>
</html>

